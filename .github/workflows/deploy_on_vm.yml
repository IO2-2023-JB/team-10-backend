name: Deploy on VM

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted

    env:
      DOTNET_INSTALL_DIR: ~/production/dotnet

    steps:
      - uses: actions/checkout@v3

      - name: Stop service
        run: sudo systemctl stop io2_api_production.service

      - name: Delete current build
        run: sudo rm -rf ~/production/backend

      - name: Install .NET Core 6.0.x
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: Publish app
        run: dotnet publish -c Release -o ~/production/backend

      - name: Restart service
        run: sudo systemctl restart io2_api_production.service
        if: always()
